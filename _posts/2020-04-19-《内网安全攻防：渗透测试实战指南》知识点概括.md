---
layout: post
title: 《内网安全攻防：渗透测试实战指南》知识点概括
description: ""
keywords: ""
---

# 第1章：内网渗透测试基础

## 内网

**内网也指局域网（Local Area Network，LAN）**是指在某一区域内由多台计算机互联成的计算机组。

## 工作组

**工作组（Work Group）就像一个可以自由进入和退出的社团**，方便同组的计算机互相访问。没有集中管理作用，所有计算机都是**对等的**。

## 域

**域（Domain）是一个有安全边界的计算机集合**。 可以简单的把域理解成升级版的工作组，但有一个严格的集中管理控制机制。

**域控制器（Domain Controller，DC）相当于一个单位的门禁系统。**DC中存在由这个域的账户、密码、属于这个域的计算机等信息构成的**数据库**。**DC是整个域的通信枢纽。**

域环境：单域、父域和子域、域树（tree）、域森林（forest，林）、DNS域名服务器

## 活动目录

**活动目录（Active Directory，AD）是域环境中提供目录服务的组件。** 目录用于存储有关网络对象（如用户、组、计算机、共享资源、打印机和联系人等）的信息。目录服务是帮助用户快速准确的从目录中查找到他所需要的信息的服务。其中将层次结构的目录及索引信息存储在数据库中，就是活动目录数据库（AD库）。

管理层次分明：**A集团（域森林） -> 子公司（域树） -> 部门（域） -> 员工**

**AD相当于树干。**

活动目录有什么功能?

1. 帐号集中管理：所有帐号均存储在服务器中，以便执行命令和重置密码等。
2. 软件集中管理：统一推送软件，统一安装网络打印机等。利用软件发布策略分发软件，可以让用户自由选择安装软件。
3. 环境集中管理：利用AD可以统一客户端桌面，IE，TCP/IP等设置。
4. 增强安全性：统一部署杀毒软件和病毒扫描任务、集中化管理用户的计算机权限、统一制订用户密码策略等。可以监控网络，对资料进行统一管理。
5. 更可靠，更少的宕机时间：例如：利用AD控制用户访问权限，利用群集、负载均衡等技术对文件服务器进行容灾设定。网络更可靠，岩机时间更少。

## DC和AD区别？

如果内网中的一台计算机上安装了AD，它就变成了DC（用于存储AD库的计算机）。

DC的本质是一台计算机，AD的本质是提供目录服务的组件。

## 安全域的划分

安全域划分的目的是将一组安全等级相同的计算机划入同一个网段内， 在网络边界上通过防火墙来实现对其他安全域的NACL（网络访问控制策略）， 使得其风险最小化。

**一般安全域划分为：DMZ和内网。**

**DMZ（Demilitarized Zone 非军事化区）称为隔离区。 为了解决安装防火墙后外部网络不能访问内部网络服务器的问题，而设立的一个非安全系统与安全系统之间的缓冲区。**

DMZ不能访问内网，DMZ不能访问外网（此策略有例外，如mail服务）。

**内网又可以划分为：办公区和核心区。**

办公区会安装防病毒软件、主机入侵检测产品（HIDS）等，运维使用堡垒机（跳板机）来统一管理用户的登陆行为。

## 域内计算机分类

域控制器、成员服务器、客户机和独立服务器。

## 域内权限

**域内置组分为：域本地组（Domain Local Group）、全局组（Global Group）、通用组（Universal Group）。**管理员通过配置安全组访问权限，就可以为所有加入安全组的用户账号配置同样的权限。

**全局组相当于域账号，可以在全局使用，域本地组相当于本地账号，只能本机上使用。**

e.g. 将用户张三（域帐号Z3）加入到域本地组administrators中，并不能使Z3对非DC的域成员计算机有任何特权，但若加入到全局组Domain Admins中，张三就是域管理员了，可以在全局使用，对域成员计算机是有特权的。

A-G-DL-P策略， A（Account）、G、 DL、 P（Permission），**是指将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地组分配资源权限。** 在A-G-DL-P策略形成以后，当给一个用户某一个权限的时候，只要把这个用户加入到某一个域本地组就可以了。

e.g. 有两个域，A和B，A中的5个财务人员和B中的3个财务人员都需要访问B中的“FINA”文件夹。这时，可以在B中建一个DL(域本地组)，因为DL的成员可以来自所有的域，然后把这8个人都加入这个DL，并把FINA的访问权赋给DL。这样做的坏处是什么呢？因为DL是在B域中，所以管理权也在B域，如果A域中的5 个人变成6个人，那只能A域管理员通知B域管理员，将DL的成员做一下修改，B域的管理员太累了。这时候，我们改变一下，在A和B域中都各建立一个全局组（G），然后在B域中建立一个DL，把这两个G都加入B域中的DL中，然后把FINA的访问权赋给 DL。哈哈，这下两个G组都有权访问FINA文件夹了，是吗？组嵌套造成权限继承嘛！这时候，两个G分布在A和B域中，也就是A和B的管理员都可以自己管理自己的G啦，只要把那5个人和3个人加入G中，就可以了！以后有任何修改，都可以自己做了，不用麻烦B域的管理员！这就是A-G-DL-P。

**域本地组来自全林，作用于本域；全局组来自本域，作用于全林；通用组来自全林，作用于全林。**

常用DL： Administrators（管理员组），最重要的权限； Remote Desktop Users（远程登录组）。

常用G： Domain Admins（域管理员组），最最重要的权限，一般来说域渗透是看重这个； Domain Users（域用户组）。

常见U： Enterprise Admins（企业系统管理员组）、 Schema Admins（架构管理员组），也是最最重要的权限。

# 第2章：内网信息搜集

## 搜集本机信息

网络配置信息、操作系统及软件的信息、本机服务信息、进程列表、启动程序信息、计划任务、主机开机时间、用户列表、连接会话、端口列表、补丁列表、本机共享列表、路由表和Arp缓存表、防火墙相关配置、代理配置情况、远程连接服务等。

**WMIC（Windows Management Instrumentation Command-Line，Windows管理工具命令行）**是最有用的Windows命令行工具。Windows7以上版本的低权限用户才允许访问WMIC并执行相关查询操作。使用WMIC，不仅可以管理本地计算机，还可以管理同一域内的所有计算机（需要一定权限），而且在被管理的计算机上不可事先安装WMIC。

WMIC在信息搜集he后渗透测试阶段是非常实用的，可以调取和查看目标机器的进程、服务、用户、用户组、网络连接、硬盘信息、网络共享信息、已安装的补丁、启动项、已安装的软件、操作系统的相关信息、时区等。使用`wimic /?`查看alias。

设置计划任务`at`在Win8已经弃用，取而代之的是`schtasks`。

安全狗禁止`net`，360也会弹窗，可以尝试`net1`，或者使用`wmic`，如net user -> wmic useraccount。

## 查询当前权限

有三种情况：本地普通用户、本地管理员用户、域内用户。

**如果当前内网中存在域，那么本地普通用户只能查询本机相关信息，不能查询域内信息；而本地管理员用户和域内用户可以查询域内信息。**

域内的所有查询都是通过域控制器实现的（基于LDAP协议），而这个查询需要经过权限认证，所以，只有域用户才拥有这个权限；当域用户执行查询命令时，会自动使用Kerberos协议进行认证，无需额外输入账号和密码。

**本地管理员Administrator权限可以直接提升为System权限**（使用PsExec等），因此，**在域中，除普通用户外，所有的机器都有一个机器用户（用户名为机器名加上$）**。在本质上，**机器的system用户对应的就是域里面的机器用户。**所以，使用System权限也可以运行域内的查询命令。

## 判断是否存在域

域控制器和DNS服务器是否在同一台服务器上？（使用nslookup反向解析）

`systeminfo`中的域即域名、登陆服务器指的是域控制器。

使用`net time /domain`可以判断当前用户是否是域用户（错误5），是否存在域。

## 探测域内存活主机

NetBIOS是局域网程序使用的一种API，为程序提供了请求低级别服务的统一的命令集。NetBIOS也是计算机的标识名，主要用于局域网中计算机的互访。

e.g. ARP（nbtscan、arp-scan）、ICMP（ping）、TCP/UDP（portscan、scanline）

## 扫描域内端口

端口的Banner信息，使用nc、telnet可以快速获取。

## 收集域内基础信息

**域内查询命令在本质上都是通过LDAP协议到域控制器上进行查询的。**

查询域、域内所有计算机、域内所有用户组列表（Domain Admins、Domain Controllers、Domain Users）、获取域密码信息、获取域信任信息。

在默认情况下，Domain Admins 和 Enterprise Admins 对域内所有域控制器有完全控制权限。

## 查找域控制器

## 获取域内的用户和管理员信息

查询所有域用户列表，查询域管理员用户。

域内Domain Admins组中的用户默认为域内机器的本地管理员用户。

## 定位域管理员

在内网中，通常会部署大量的网络安全系统和设备，例如IDS、IPS、日志审计、安全网关、反病毒软件等。

**在一个域中，当计算机加入域后，会默认给域管理员组赋予本地系统管理员权限。**也就是说，当计算机被添加到域中，成为域的成员主机后，系统会自动将域管理员组添加到本地系统管理员组中。因此，域管理员组的成员均可访问本地计算机，且具备完全控制权限。

在Windows域中取得了普通用户权限，希望在域内横向移动，需要知道域内用户登录的位置、他是否是任何系统的本地管理员、他所属的组、他是否有权访问文件共享等。

e.g. psloggedon.exe、PVEFindADUser.exe、netsess.exe、hunter、NetView、PowerView等

## 查找域管理进程

在获取了管理员权限的系统中寻找域管理员登录进程，进而搜集域管理员的凭据。

渗透测试人员在某个内网环境中获得了一个**域普通用户**的权限，首先通过各种方法获得当前服务器的**本地管理员**权限，然后分析当前服务器的用户登录列表及会话信息，知道哪些用户登陆了这台服务器。如果渗透测试人员通过分析发现，可以获取权限的登录用户都不是域管理员账户，同时没有域管理员组的用户登录这台服务器，就可以使用另一个账号并寻找该账号在内网的哪台机器上具有管理权限，再枚举这台机器上的登录用户，然后继续进行渗透测试，直至找到一个可以获取域管理员权限的有效路径为止。

## 域管理员模拟

第4章介绍

## 内网划分及拓扑结构

分析目标服务器所使用的的Web服务器、后端脚本、数据库、系统平台等。

常见Web架构：

- ASP + Access + IIS 5.0/6.0 + Windows Server 2003
- ASPX + MSSQL + IIS 7.0/7.5 + Windows Server 2008
- PHP + MySQL + IIS、Apache、Nginx
- JSP + MSSQL、ORACLE + Tomcat

内网通常分为DMZ、办公区和核心区（生产区）。

# 第3章：隐藏通信隧道技术

## 判断内网的连通性

隐藏通信隧道技术常用于在访问受限的网络环境中追踪数据流向和在非受信任的网络中实现安全的数据传输。

在实际的网络中，通常会通过各种边界设备、软/硬件防火墙甚至入侵检测系统来**检查主机对外的网络连接情况**，如果发现异常，就会对通信进行阻断。

隧道，就是一种绕过端口屏蔽的通信方式。**防火墙两端的数据包通过防火墙所允许的数据包类型或者端口进行封装，然后穿过防火墙，与对方进行通信。当被封装的数据包到达目的地时，将数据包还原，并将还原后的数据包发送到相应的服务器上。**

e.g. ICMP（ping）、TCP/UDP（nc）、HTTP（curl）、**DNS（nslookup baidu.com VPS、dig baidu.com @VPS）**

## 网络层隧道技术（IPv6、ICMP）

IPv6隧道：可以将IPv4作为隧道载体，将IPv6报文整体封装在IPv4数据报文中。e.g. socat、6tunnel、nt6tunnel等

ICMP隧道：在一般的通信协议中，如果两台设备要进行通信，肯定需要开放端口，而在ICMP协议下就不需要。e.g. **icmpsh**、PingTunnel、icmptunnel、powershell icmp等

防御：检测数量、报文大小、特征标识等。一个正常的ping每秒最多发送两个数据包，而使用ICMP隧道数量会激增。

## 传输层隧道技术（TCP、UDP）

e.g. lcx、**netcat（nc -c参数）**、PowerCat

各种语言的反弹shell。

## 应用层隧道技术（SSH、HTTP/s、DNS）

**SSH：-CfNg，-L本地端口转发，-R远程端口转发，-D动态转发（SOCKS代理）**

防御：白名单、ACL限制请求IP。

**HTTP/s：reGeorg**、meterpreter、tunna等

DNS：DNS是一个必不可少的服务，DNS报文本身具有穿透防火墙的能力。

从DNS协议的角度看，只是在一次次的查询某个特定的域名并得到解析结果，但其本质问题是，预期的返回结果应该是一个IP地址，而事实返回的是任意字符串，包括加密的C2指令。

**DNS隧道本质是将其他协议封装在DNS协议中进行传输。**

## SOCKS代理

SOCKS是"SOCKetS"的缩写。

SOCKS4只支持TCP协议；SOCKS5不仅支持TCP/UDP协议，还支持各种身份验证机制。

SOCKS代理更底层，是在会话层；而HTTP代理是在应用层。因此SOCKS代理可以代理一切客户端的连接，而HTTP代理只能代理使用HTTP协议的客户端。由于更底层，不需要处理高级协议的细节，所以socks代理更快。

SOCKET被称作"套接字"，用于描述IP地址和端口，是一个通信链的句柄，可以用来实现不同计算机之间的通信，它的本质是编程接口(API)，是对TCP/IP的封装。SOCKS是一个代理协议，目前最新版本为SOCKS5，所谓代理就是，你可以通过它的去间接的访问网络，相当于一个中转站。区别：SOCKET是一个API，一个工具，让你建立网络连接用的。SOCKS是协议，是一组数据结构。

目前VPN隧道协议主要有4种：点到点隧道协议PPTP、第二层隧道协议L2TP、网络层隧道协议IPSec以及SOCKS v5协议。其中，PPTP和L2TP工作在数据链路层，IPSec工作在网络层，SOCKS v5工作在会话层。

e.g. EarthWorm（ew、新版本Termite）、reGeorg、sSocks、SocksCap64（SSTap）、Proxifier、ProxyChains

## 压缩数据

e.g. rar.exe、7z.exe

## 上传和下载

e.g. ftp、vbs、bitsadmin、powershell等等

Powershell的最大优势在于以.NET框架为基础，.NET框架在脚本领域几乎是无所不能的，因此ps1脚本文件的执行默认是被禁止的。